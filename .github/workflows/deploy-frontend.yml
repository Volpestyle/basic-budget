name: Deploy Frontend

on:
  workflow_run:
    workflows: ["Deploy Infrastructure"]
    types: [completed]
    branches: [main, develop]
  push:
    branches: [main, develop]
    paths:
      - 'packages/web/**'
      - '.github/workflows/deploy-frontend.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
        - dev
        - staging
        - prod

env:
  AWS_REGION: us-east-1
  NODE_VERSION: '20'

jobs:
  determine-environment:
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      should-deploy: ${{ steps.set-env.outputs.should-deploy }}
    steps:
      - name: Determine environment and deployment
        id: set-env
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "environment=${{ inputs.environment }}" >> $GITHUB_OUTPUT
            echo "should-deploy=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "workflow_run" ]]; then
            if [[ "${{ github.event.workflow_run.head_branch }}" == "main" ]]; then
              echo "environment=prod" >> $GITHUB_OUTPUT
            elif [[ "${{ github.event.workflow_run.head_branch }}" == "develop" ]]; then
              echo "environment=staging" >> $GITHUB_OUTPUT
            else
              echo "environment=dev" >> $GITHUB_OUTPUT
            fi
            echo "should-deploy=${{ github.event.workflow_run.conclusion == 'success' }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "environment=prod" >> $GITHUB_OUTPUT
            echo "should-deploy=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            echo "environment=staging" >> $GITHUB_OUTPUT
            echo "should-deploy=true" >> $GITHUB_OUTPUT
          else
            echo "environment=dev" >> $GITHUB_OUTPUT
            echo "should-deploy=true" >> $GITHUB_OUTPUT
          fi

  build-frontend:
    runs-on: ubuntu-latest
    needs: determine-environment
    if: needs.determine-environment.outputs.should-deploy == 'true'
    defaults:
      run:
        working-directory: ./packages/web
    outputs:
      build-hash: ${{ steps.build-info.outputs.build-hash }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: packages/web/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Download infrastructure outputs
        uses: actions/download-artifact@v4
        with:
          name: deployment-outputs-${{ needs.determine-environment.outputs.environment }}
          path: ./
        continue-on-error: true

      - name: Load environment variables
        run: |
          if [[ -f deployment-outputs.env ]]; then
            cat deployment-outputs.env >> $GITHUB_ENV
          fi

      - name: Run tests
        run: npm run test -- --coverage --watchAll=false

      - name: Run type checking
        run: npm run type-check || npx tsc --noEmit

      - name: Run linting
        run: npm run lint

      - name: Build application
        env:
          REACT_APP_API_URL: ${{ env.API_URL || 'https://api.basic-budget.local' }}
          REACT_APP_ENVIRONMENT: ${{ needs.determine-environment.outputs.environment }}
          REACT_APP_VERSION: ${{ github.sha }}
          NODE_ENV: production
        run: |
          npm run build

      - name: Generate build info
        id: build-info
        run: |
          BUILD_HASH=$(find build -type f -exec sha256sum {} \; | sha256sum | cut -d' ' -f1)
          echo "build-hash=${BUILD_HASH}" >> $GITHUB_OUTPUT
          
          # Create build manifest
          cat > build/build-info.json << EOF
          {
            "version": "${{ github.sha }}",
            "buildTime": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "environment": "${{ needs.determine-environment.outputs.environment }}",
            "buildHash": "${BUILD_HASH}",
            "gitRef": "${{ github.ref }}",
            "gitSha": "${{ github.sha }}"
          }
          EOF

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build-${{ needs.determine-environment.outputs.environment }}
          path: packages/web/build/
          retention-days: 30

  deploy-frontend:
    runs-on: ubuntu-latest
    needs: [determine-environment, build-frontend]
    if: needs.determine-environment.outputs.should-deploy == 'true'
    environment:
      name: ${{ needs.determine-environment.outputs.environment }}
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-build-${{ needs.determine-environment.outputs.environment }}
          path: ./build

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_FRONTEND_DEPLOYMENT_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-FrontendDeploy

      - name: Get S3 bucket and CloudFront distribution
        id: get-resources
        run: |
          BUCKET_NAME=$(aws cloudformation describe-stacks \
            --stack-name "basic-budget-frontend-${{ needs.determine-environment.outputs.environment }}" \
            --query 'Stacks[0].Outputs[?OutputKey==`BucketName`].OutputValue' \
            --output text)
          
          DISTRIBUTION_ID=$(aws cloudformation describe-stacks \
            --stack-name "basic-budget-frontend-${{ needs.determine-environment.outputs.environment }}" \
            --query 'Stacks[0].Outputs[?OutputKey==`DistributionId`].OutputValue' \
            --output text)
          
          echo "bucket-name=${BUCKET_NAME}" >> $GITHUB_OUTPUT
          echo "distribution-id=${DISTRIBUTION_ID}" >> $GITHUB_OUTPUT

      - name: Deploy to S3
        run: |
          # Sync build files to S3
          aws s3 sync ./build/ s3://${{ steps.get-resources.outputs.bucket-name }}/ \
            --delete \
            --cache-control "public,max-age=31536000" \
            --exclude "*.html" \
            --exclude "build-info.json"
          
          # Upload HTML files with no-cache policy
          aws s3 sync ./build/ s3://${{ steps.get-resources.outputs.bucket-name }}/ \
            --cache-control "public,max-age=0,must-revalidate" \
            --include "*.html" \
            --include "build-info.json"

      - name: Create CloudFront invalidation
        id: invalidation
        run: |
          INVALIDATION_ID=$(aws cloudfront create-invalidation \
            --distribution-id ${{ steps.get-resources.outputs.distribution-id }} \
            --paths "/*" \
            --query 'Invalidation.Id' \
            --output text)
          
          echo "invalidation-id=${INVALIDATION_ID}" >> $GITHUB_OUTPUT

      - name: Wait for CloudFront invalidation
        run: |
          echo "Waiting for CloudFront invalidation to complete..."
          aws cloudfront wait invalidation-completed \
            --distribution-id ${{ steps.get-resources.outputs.distribution-id }} \
            --id ${{ steps.invalidation.outputs.invalidation-id }}
          echo "CloudFront invalidation completed"

      - name: Verify deployment
        run: |
          # Get CloudFront domain
          DOMAIN_NAME=$(aws cloudformation describe-stacks \
            --stack-name "basic-budget-frontend-${{ needs.determine-environment.outputs.environment }}" \
            --query 'Stacks[0].Outputs[?OutputKey==`DistributionDomainName`].OutputValue' \
            --output text)
          
          # Test the deployment
          echo "Testing deployment at https://${DOMAIN_NAME}"
          
          # Wait a moment for propagation
          sleep 30
          
          # Check if the site is accessible
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://${DOMAIN_NAME}/build-info.json" || echo "000")
          
          if [[ "$HTTP_STATUS" == "200" ]]; then
            echo "✅ Frontend deployment successful!"
            curl -s "https://${DOMAIN_NAME}/build-info.json" | jq .
          else
            echo "⚠️ Frontend may still be propagating (HTTP $HTTP_STATUS)"
          fi

      - name: Create deployment summary
        run: |
          DOMAIN_NAME=$(aws cloudformation describe-stacks \
            --stack-name "basic-budget-frontend-${{ needs.determine-environment.outputs.environment }}" \
            --query 'Stacks[0].Outputs[?OutputKey==`DistributionDomainName`].OutputValue' \
            --output text)
          
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## Frontend Deployment Summary
          
          **Environment:** ${{ needs.determine-environment.outputs.environment }}
          **Build Hash:** ${{ needs.build-frontend.outputs.build-hash }}
          **S3 Bucket:** ${{ steps.get-resources.outputs.bucket-name }}
          **CloudFront Distribution:** ${{ steps.get-resources.outputs.distribution-id }}
          **Application URL:** https://${DOMAIN_NAME}
          
          ### Deployment Details
          - Build artifacts uploaded to S3
          - CloudFront invalidation completed
          - Application is now live
          EOF

  run-e2e-tests:
    runs-on: ubuntu-latest
    needs: [determine-environment, deploy-frontend]
    if: needs.determine-environment.outputs.should-deploy == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Get application URL
        id: get-url
        run: |
          DOMAIN_NAME=$(aws cloudformation describe-stacks \
            --stack-name "basic-budget-frontend-${{ needs.determine-environment.outputs.environment }}" \
            --query 'Stacks[0].Outputs[?OutputKey==`DistributionDomainName`].OutputValue' \
            --output text)
          
          echo "app-url=https://${DOMAIN_NAME}" >> $GITHUB_OUTPUT

      - name: Run basic smoke tests
        run: |
          echo "Running smoke tests against ${{ steps.get-url.outputs.app-url }}"
          
          # Basic connectivity test
          curl -f "${{ steps.get-url.outputs.app-url }}" > /dev/null
          
          # Test build info endpoint
          curl -f "${{ steps.get-url.outputs.app-url }}/build-info.json" | jq .
          
          echo "✅ Smoke tests passed"