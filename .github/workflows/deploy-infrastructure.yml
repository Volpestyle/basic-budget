name: Deploy Infrastructure

on:
  push:
    branches: [main, develop]
    paths:
      - 'infrastructure/**'
      - '.github/workflows/deploy-infrastructure.yml'
  pull_request:
    branches: [main]
    paths:
      - 'infrastructure/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
        - dev
        - staging
        - prod

env:
  AWS_REGION: us-east-1
  NODE_VERSION: '20'

jobs:
  determine-environment:
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      should-deploy: ${{ steps.set-env.outputs.should-deploy }}
    steps:
      - name: Determine environment and deployment
        id: set-env
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "environment=${{ inputs.environment }}" >> $GITHUB_OUTPUT
            echo "should-deploy=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "environment=prod" >> $GITHUB_OUTPUT
            echo "should-deploy=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            echo "environment=staging" >> $GITHUB_OUTPUT
            echo "should-deploy=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "environment=dev" >> $GITHUB_OUTPUT
            echo "should-deploy=false" >> $GITHUB_OUTPUT
          else
            echo "environment=dev" >> $GITHUB_OUTPUT
            echo "should-deploy=true" >> $GITHUB_OUTPUT
          fi

  validate-infrastructure:
    runs-on: ubuntu-latest
    needs: determine-environment
    defaults:
      run:
        working-directory: ./infrastructure
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: infrastructure/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run TypeScript compilation
        run: npm run build

      - name: Run CDK lint/validation
        run: |
          npx cdk synth --context environment=${{ needs.determine-environment.outputs.environment }} --strict

      - name: Run security checks
        run: |
          npm audit --audit-level=high
          # Add additional security scanning tools as needed

  deploy-infrastructure:
    runs-on: ubuntu-latest
    needs: [determine-environment, validate-infrastructure]
    if: needs.determine-environment.outputs.should-deploy == 'true'
    environment:
      name: ${{ needs.determine-environment.outputs.environment }}
      url: ${{ steps.deploy.outputs.app-url }}
    permissions:
      id-token: write
      contents: read
    defaults:
      run:
        working-directory: ./infrastructure
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: infrastructure/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_DEPLOYMENT_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-InfrastructureDeploy

      - name: Deploy CDK infrastructure
        id: deploy
        run: |
          # Bootstrap CDK if needed
          npx cdk bootstrap --context environment=${{ needs.determine-environment.outputs.environment }}
          
          # Deploy all stacks
          npx cdk deploy --all \
            --context environment=${{ needs.determine-environment.outputs.environment }} \
            --require-approval never \
            --outputs-file outputs.json

          # Extract outputs for use in subsequent jobs
          if [[ -f outputs.json ]]; then
            APP_URL=$(jq -r '.["BasicBudgetInfrastructure-${{ needs.determine-environment.outputs.environment }}"].ApplicationUrl // empty' outputs.json)
            API_URL=$(jq -r '.["BasicBudgetInfrastructure-${{ needs.determine-environment.outputs.environment }}"].ApiEndpoint // empty' outputs.json)
            
            echo "app-url=${APP_URL}" >> $GITHUB_OUTPUT
            echo "api-url=${API_URL}" >> $GITHUB_OUTPUT
            
            # Store outputs as artifacts for other workflows
            echo "APP_URL=${APP_URL}" >> deployment-outputs.env
            echo "API_URL=${API_URL}" >> deployment-outputs.env
            echo "ENVIRONMENT=${{ needs.determine-environment.outputs.environment }}" >> deployment-outputs.env
          fi

      - name: Upload deployment outputs
        uses: actions/upload-artifact@v4
        with:
          name: deployment-outputs-${{ needs.determine-environment.outputs.environment }}
          path: infrastructure/deployment-outputs.env
          retention-days: 30

      - name: Run post-deployment tests
        run: |
          # Add infrastructure validation tests
          if [[ -n "${{ steps.deploy.outputs.api-url }}" ]]; then
            echo "Testing API health endpoint..."
            curl -f "${{ steps.deploy.outputs.api-url }}/api/health" || echo "Health check failed"
          fi

      - name: Create deployment summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## Infrastructure Deployment Summary
          
          **Environment:** ${{ needs.determine-environment.outputs.environment }}
          **Region:** ${{ env.AWS_REGION }}
          **Application URL:** ${{ steps.deploy.outputs.app-url }}
          **API URL:** ${{ steps.deploy.outputs.api-url }}
          
          ### Deployed Stacks
          - Database Stack (VPC, RDS Aurora Serverless v2, RDS Proxy)
          - API Stack (Lambda, API Gateway v2)
          - Frontend Stack (S3, CloudFront)
          - Paystub Stack (Go Lambda, ECR, SQS)
          EOF

  notify-deployment:
    runs-on: ubuntu-latest
    needs: [determine-environment, deploy-infrastructure]
    if: always() && needs.determine-environment.outputs.should-deploy == 'true'
    steps:
      - name: Notify deployment status
        run: |
          if [[ "${{ needs.deploy-infrastructure.result }}" == "success" ]]; then
            echo "✅ Infrastructure deployment successful for ${{ needs.determine-environment.outputs.environment }}"
          else
            echo "❌ Infrastructure deployment failed for ${{ needs.determine-environment.outputs.environment }}"
            exit 1
          fi