name: Deploy Infrastructure

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'infrastructure/**'
      - '.github/workflows/deploy.yml'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'infrastructure/**'

  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod
      action:
        description: 'Action to perform'
        required: true
        default: 'deploy'
        type: choice
        options:
          - deploy
          - destroy
          - diff

env:
  AWS_DEFAULT_REGION: us-east-1
  NODE_VERSION: 18

jobs:
  # Determine deployment environment and validate changes
  determine-environment:
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      should-deploy: ${{ steps.set-env.outputs.should-deploy }}
    steps:
      - name: Determine Environment
        id: set-env
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
            echo "should-deploy=true" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "environment=prod" >> $GITHUB_OUTPUT
            echo "should-deploy=true" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" = "refs/heads/develop" ]; then
            echo "environment=staging" >> $GITHUB_OUTPUT
            echo "should-deploy=true" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "environment=dev" >> $GITHUB_OUTPUT
            echo "should-deploy=false" >> $GITHUB_OUTPUT
          else
            echo "environment=dev" >> $GITHUB_OUTPUT
            echo "should-deploy=false" >> $GITHUB_OUTPUT
          fi

  # Lint and validate CDK code
  validate:
    runs-on: ubuntu-latest
    needs: determine-environment
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: infrastructure/package-lock.json

      - name: Install Dependencies
        run: |
          cd infrastructure
          npm ci

      - name: Lint TypeScript
        run: |
          cd infrastructure
          npm run build

      - name: Run Tests
        run: |
          cd infrastructure
          npm test
        continue-on-error: true

      - name: CDK Synth Validation
        run: |
          cd infrastructure
          npx cdk synth --context environment=${{ needs.determine-environment.outputs.environment }} --quiet

  # Security and compliance scanning
  security-scan:
    runs-on: ubuntu-latest
    needs: [determine-environment, validate]
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Run Checkov Security Scan
        uses: bridgecrewio/checkov-action@master
        with:
          directory: infrastructure/
          framework: cloudformation
          soft_fail: true
          output_format: sarif
          output_file_path: checkov-results.sarif

      - name: Upload Checkov Results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: checkov-results.sarif

  # Deploy to development for PRs (diff only)
  pr-validation:
    runs-on: ubuntu-latest
    needs: [determine-environment, validate]
    if: github.event_name == 'pull_request'
    environment: dev
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: infrastructure/package-lock.json

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_DEFAULT_REGION }}

      - name: Install Dependencies
        run: |
          cd infrastructure
          npm ci

      - name: CDK Bootstrap (if needed)
        run: |
          cd infrastructure
          npx cdk bootstrap aws://${{ secrets.AWS_ACCOUNT_ID }}/${{ env.AWS_DEFAULT_REGION }} \
            --context environment=dev

      - name: CDK Diff
        run: |
          cd infrastructure
          npx cdk diff --context environment=dev

  # Deploy infrastructure
  deploy:
    runs-on: ubuntu-latest
    needs: [determine-environment, validate, security-scan]
    if: needs.determine-environment.outputs.should-deploy == 'true'
    environment: ${{ needs.determine-environment.outputs.environment }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: infrastructure/package-lock.json

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_DEFAULT_REGION }}

      - name: Install Dependencies
        run: |
          cd infrastructure
          npm ci

      - name: CDK Bootstrap
        run: |
          cd infrastructure
          npx cdk bootstrap aws://${{ secrets.AWS_ACCOUNT_ID }}/${{ env.AWS_DEFAULT_REGION }} \
            --context environment=${{ needs.determine-environment.outputs.environment }}

      - name: CDK Deploy
        if: github.event.inputs.action != 'destroy' && github.event.inputs.action != 'diff'
        run: |
          cd infrastructure
          npx cdk deploy --all \
            --context environment=${{ needs.determine-environment.outputs.environment }} \
            --context alarmEmail=${{ secrets.ALARM_EMAIL }} \
            --require-approval never

      - name: CDK Diff
        if: github.event.inputs.action == 'diff'
        run: |
          cd infrastructure
          npx cdk diff --context environment=${{ needs.determine-environment.outputs.environment }}

      - name: CDK Destroy
        if: github.event.inputs.action == 'destroy'
        run: |
          cd infrastructure
          npx cdk destroy --all \
            --context environment=${{ needs.determine-environment.outputs.environment }} \
            --force

      - name: Store Deployment Outputs
        if: success() && github.event.inputs.action != 'destroy' && github.event.inputs.action != 'diff'
        run: |
          cd infrastructure
          npx cdk deploy --all \
            --context environment=${{ needs.determine-environment.outputs.environment }} \
            --outputs-file cdk-outputs.json \
            --require-approval never || true

      - name: Upload Deployment Artifacts
        if: success() && github.event.inputs.action != 'destroy'
        uses: actions/upload-artifact@v4
        with:
          name: cdk-outputs-${{ needs.determine-environment.outputs.environment }}
          path: infrastructure/cdk-outputs.json
          retention-days: 30

  # Deploy frontend application
  deploy-frontend:
    runs-on: ubuntu-latest
    needs: [determine-environment, deploy]
    if: needs.determine-environment.outputs.should-deploy == 'true' && needs.deploy.result == 'success'
    environment: ${{ needs.determine-environment.outputs.environment }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_DEFAULT_REGION }}

      - name: Download Deployment Outputs
        uses: actions/download-artifact@v4
        with:
          name: cdk-outputs-${{ needs.determine-environment.outputs.environment }}
          path: ./

      - name: Build Frontend Application
        run: |
          # Navigate to frontend directory (adjust path as needed)
          cd mock  # Assuming this is your React app directory
          
          # Install dependencies
          npm ci
          
          # Set environment variables from CDK outputs
          export VITE_API_ENDPOINT=$(cat ../cdk-outputs.json | jq -r '.BasicBudget*Api.ApiEndpoint // empty')
          export VITE_ENVIRONMENT=${{ needs.determine-environment.outputs.environment }}
          
          # Build the application
          npm run build

      - name: Deploy to S3
        run: |
          # Get S3 bucket name from CDK outputs
          BUCKET_NAME=$(cat cdk-outputs.json | jq -r '.BasicBudget*Frontend.FrontendBucketName // empty')
          
          if [ -n "$BUCKET_NAME" ]; then
            echo "Deploying to S3 bucket: $BUCKET_NAME"
            aws s3 sync mock/dist/ s3://$BUCKET_NAME/ --delete
          else
            echo "Could not find S3 bucket name in CDK outputs"
            exit 1
          fi

      - name: Invalidate CloudFront Cache
        run: |
          # Get CloudFront distribution ID from CDK outputs
          DISTRIBUTION_ID=$(cat cdk-outputs.json | jq -r '.BasicBudget*Frontend.DistributionId // empty')
          
          if [ -n "$DISTRIBUTION_ID" ]; then
            echo "Invalidating CloudFront distribution: $DISTRIBUTION_ID"
            aws cloudfront create-invalidation \
              --distribution-id $DISTRIBUTION_ID \
              --paths "/*"
          else
            echo "Could not find CloudFront distribution ID in CDK outputs"
            exit 1
          fi

  # Run post-deployment tests
  post-deployment-tests:
    runs-on: ubuntu-latest
    needs: [determine-environment, deploy, deploy-frontend]
    if: needs.determine-environment.outputs.should-deploy == 'true' && needs.deploy.result == 'success'
    environment: ${{ needs.determine-environment.outputs.environment }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_DEFAULT_REGION }}

      - name: Download Deployment Outputs
        uses: actions/download-artifact@v4
        with:
          name: cdk-outputs-${{ needs.determine-environment.outputs.environment }}
          path: ./

      - name: Health Check API
        run: |
          API_ENDPOINT=$(cat cdk-outputs.json | jq -r '.BasicBudget*Api.ApiEndpoint // empty')
          
          if [ -n "$API_ENDPOINT" ]; then
            echo "Testing API endpoint: $API_ENDPOINT/health"
            
            # Wait for API to be ready
            for i in {1..30}; do
              if curl -s "$API_ENDPOINT/health" | grep -q "ok\|healthy\|success"; then
                echo "API health check passed"
                break
              fi
              echo "Waiting for API to be ready... ($i/30)"
              sleep 10
            done
          fi

      - name: Health Check Frontend
        run: |
          WEBSITE_URL=$(cat cdk-outputs.json | jq -r '.BasicBudget*Frontend.WebsiteURL // empty')
          
          if [ -n "$WEBSITE_URL" ]; then
            echo "Testing frontend: $WEBSITE_URL"
            
            # Wait for CloudFront to serve content
            for i in {1..20}; do
              if curl -s -o /dev/null -w "%{http_code}" "$WEBSITE_URL" | grep -q "200"; then
                echo "Frontend health check passed"
                break
              fi
              echo "Waiting for frontend to be ready... ($i/20)"
              sleep 15
            done
          fi

      - name: Run Integration Tests
        run: |
          # Run any integration tests here
          echo "Integration tests would run here"
          # Example: npm run test:integration

  # Notification step
  notify:
    runs-on: ubuntu-latest
    needs: [determine-environment, deploy, deploy-frontend, post-deployment-tests]
    if: always() && needs.determine-environment.outputs.should-deploy == 'true'
    steps:
      - name: Notify Success
        if: needs.deploy.result == 'success' && needs.deploy-frontend.result == 'success'
        run: |
          echo "üéâ Deployment to ${{ needs.determine-environment.outputs.environment }} completed successfully!"

      - name: Notify Failure
        if: needs.deploy.result == 'failure' || needs.deploy-frontend.result == 'failure'
        run: |
          echo "‚ùå Deployment to ${{ needs.determine-environment.outputs.environment }} failed!"
          exit 1